<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Jadwal Mengajar Dosen - Terintegrasi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            margin: 0 30px;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #bdc3c7;
            color: #2c3e50;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 13px;
            min-width: 120px;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #95a5a6;
            color: white;
        }

        .content {
            padding: 30px;
        }

        .schedule-section {
            display: none;
        }

        .schedule-section.active {
            display: block;
        }

        /* Mata Kuliah Management */
        .matkul-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 100px 150px 150px auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .matkul-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card-small {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card-small .number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card-small .label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .matkul-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .matkul-category {
            margin-bottom: 20px;
        }

        .category-header {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .matkul-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #ecf0f1;
            transition: background-color 0.3s ease;
        }

        .matkul-item:hover {
            background: #f8f9fa;
        }

        .matkul-info {
            flex: 1;
        }

        .matkul-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .matkul-details {
            font-size: 12px;
            color: #7f8c8d;
        }

        .matkul-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .schedule-table th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .schedule-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
            position: relative;
            vertical-align: top;
        }

        .schedule-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .schedule-table tr:hover {
            background: #e3f2fd;
        }

        .mata-kuliah-header {
            background: #34495e !important;
            color: white !important;
            font-weight: 600;
            padding: 12px 8px !important;
            width: 200px;
            font-size: 12px;
        }

        .waktu-header {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: 600;
            font-size: 11px;
            display: block;
            margin-top: 5px;
            padding: 3px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2) !important;
        }

        .sks-header {
            background: #e67e22 !important;
            color: white !important;
            font-weight: 600;
            font-size: 10px;
            display: block;
            margin-top: 2px;
            padding: 2px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2) !important;
        }

        .kelas-header {
            background: #34495e !important;
            color: white !important;
            font-weight: 600;
            width: 80px;
        }

        .dosen-input-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            min-height: 80px;
        }

        .dosen-select {
            width: 100%;
            padding: 4px 6px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 11px;
            transition: all 0.3s ease;
            background: white;
        }

        .dosen-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .dosen-label {
            font-size: 10px;
            font-weight: 600;
            color: #34495e;
            text-align: left;
            margin-bottom: 2px;
        }

        .sks-info {
            font-size: 9px;
            color: #e67e22;
            font-weight: 600;
            margin-top: 2px;
        }

        .conflict {
            background: #ff6b6b !important;
            animation: pulse 2s infinite;
        }

        .conflict .dosen-select {
            border-color: #e74c3c;
            background: #ffe6e6;
        }

        @keyframes pulse {
            0% { background-color: #ff6b6b; }
            50% { background-color: #ff5252; }
            100% { background-color: #ff6b6b; }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .conflict-list {
            background: #ffe6e6;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .conflict-list.show {
            display: block;
        }

        .conflict-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .summary-table th {
            background: #27ae60;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .summary-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .konsentrasi-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            margin-bottom: 10px;
        }

        .badge-matkul { background: #8e44ad; }
        .badge-umum { background: #9b59b6; }
        .badge-strategik { background: #e74c3c; }
        .badge-keuangan { background: #27ae60; }
        .badge-sdm { background: #3498db; }
        .badge-pemasaran { background: #f39c12; }

        .kelas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .kelas-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            border: 2px solid #ecf0f1;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .schedule-table {
                font-size: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Sistem Jadwal Mengajar Terintegrasi</h1>
            <p>Kelola mata kuliah kustomisasi, jadwal 15 kelas, dan perhitungan SKS otomatis</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="checkConflicts()">üîç Cek Konflik Global</button>
            <button class="btn btn-success" onclick="showSummary()">üìä Ringkasan Dosen</button>
            <button class="btn btn-warning" onclick="exportExcel()">üì§ Export Excel</button>
            <button class="btn btn-danger" onclick="resetAll()">üîÑ Reset Semua</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('matkul')">üìñ MATA KULIAH</button>
            <button class="tab" onclick="showTab('umum')">üìö KELAS UMUM</button>
            <button class="tab" onclick="showTab('strategik')">üéØ STRATEGIK</button>
            <button class="tab" onclick="showTab('keuangan')">üí∞ KEUANGAN</button>
            <button class="tab" onclick="showTab('sdm')">üë• SDM</button>
            <button class="tab" onclick="showTab('pemasaran')">üìà PEMASARAN</button>
        </div>

        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalMatkul">0</div>
                    <div class="stat-label">Total Mata Kuliah</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSKS">0</div>
                    <div class="stat-label">Total SKS Sistem</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conflictCount">0</div>
                    <div class="stat-label">Konflik Global</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueDosenCount">0</div>
                    <div class="stat-label">Dosen Aktif</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSKS">0</div>
                    <div class="stat-label">Rata¬≤ SKS/Dosen</div>
                </div>
            </div>

            <div class="conflict-list" id="conflictList">
                <h3>‚ö†Ô∏è Konflik Jadwal Global Ditemukan:</h3>
                <div id="conflictItems"></div>
            </div>

            <!-- MATA KULIAH Management Section -->
            <div id="matkul" class="schedule-section active">
                <div class="konsentrasi-badge badge-matkul">MANAJEMEN MATA KULIAH</div>
                
                <div class="matkul-form">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">‚ûï Tambah/Edit Mata Kuliah</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Mata Kuliah</label>
                            <input type="text" id="matkulName" placeholder="Contoh: Strategic Management">
                        </div>
                        <div class="form-group">
                            <label>SKS</label>
                            <input type="number" id="matkulSKS" min="1" max="6" value="3">
                        </div>
                        <div class="form-group">
                            <label>Waktu</label>
                            <select id="matkulWaktu">
                                <option value="07.30 - 10.00">07.30 - 10.00</option>
                                <option value="10.05 - 12.35">10.05 - 12.35</option>
                                <option value="10.05 - 12.00">10.05 - 12.00</option>
                                <option value="13.00 - 15.10">13.00 - 15.10</option>
                                <option value="13.00 - 15.30">13.00 - 15.30</option>
                                <option value="16.00 - 18.10">16.00 - 18.10</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="matkulKategori">
                                <option value="umum">Kelas Umum</option>
                                <option value="strategik">Strategik</option>
                                <option value="keuangan">Keuangan</option>
                                <option value="sdm">SDM</option>
                                <option value="pemasaran">Pemasaran</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addMataKuliah()">Tambah MK</button>
                        </div>
                    </div>
                </div>

                <div class="matkul-stats">
                    <div class="stat-card-small">
                        <div class="number" id="matkulUmum">0</div>
                        <div class="label">MK Umum</div>
                    </div>
                    <div class="stat-card-small">
                        <div class="number" id="matkulStrategik">0</div>
                        <div class="label">MK Strategik</div>
                    </div>
                    <div class="stat-card-small">
                        <div class="number" id="matkulKeuangan">0</div>
                        <div class="label">MK Keuangan</div>
                    </div>
                    <div class="stat-card-small">
                        <div class="number" id="matkulSDM">0</div>
                        <div class="label">MK SDM</div>
                    </div>
                    <div class="stat-card-small">
                        <div class="number" id="matkulPemasaran">0</div>
                        <div class="label">MK Pemasaran</div>
                    </div>
                </div>

                <div class="matkul-list" id="matkulList">
                    <!-- Akan diisi oleh JavaScript -->
                </div>
            </div>

            <!-- KELAS UMUM Section -->
            <div id="umum" class="schedule-section">
                <div class="konsentrasi-badge badge-umum">KELAS UMUM</div>
                <div class="kelas-grid">
                    <div class="kelas-item">B1</div>
                    <div class="kelas-item">B2</div>
                    <div class="kelas-item">B3</div>
                    <div class="kelas-item">B4</div>
                    <div class="kelas-item">B5</div>
                    <div class="kelas-item">B6</div>
                    <div class="kelas-item">B7</div>
                    <div class="kelas-item">B8</div>
                </div>
                <div id="umumScheduleContainer">
                    <!-- Tabel akan di-generate berdasarkan mata kuliah -->
                </div>
            </div>

            <!-- STRATEGIK Section -->
            <div id="strategik" class="schedule-section">
                <div class="konsentrasi-badge badge-strategik">KONSENTRASI STRATEGIK</div>
                <div class="kelas-grid">
                    <div class="kelas-item">S1</div>
                    <div class="kelas-item">S2</div>
                </div>
                <div id="strategikScheduleContainer">
                    <!-- Tabel akan di-generate berdasarkan mata kuliah -->
                </div>
            </div>

            <!-- KEUANGAN Section -->
            <div id="keuangan" class="schedule-section">
                <div class="konsentrasi-badge badge-keuangan">KONSENTRASI KEUANGAN</div>
                <div class="kelas-grid">
                    <div class="kelas-item">K1</div>
                    <div class="kelas-item">K2</div>
                </div>
                <div id="keuanganScheduleContainer">
                    <!-- Tabel akan di-generate berdasarkan mata kuliah -->
                </div>
            </div>

            <!-- SDM Section -->
            <div id="sdm" class="schedule-section">
                <div class="konsentrasi-badge badge-sdm">KONSENTRASI SDM</div>
                <div class="kelas-grid">
                    <div class="kelas-item">H1</div>
                    <div class="kelas-item">H2</div>
                </div>
                <div id="sdmScheduleContainer">
                    <!-- Tabel akan di-generate berdasarkan mata kuliah -->
                </div>
            </div>

            <!-- PEMASARAN Section -->
            <div id="pemasaran" class="schedule-section">
                <div class="konsentrasi-badge badge-pemasaran">KONSENTRASI PEMASARAN</div>
                <div class="kelas-grid">
                    <div class="kelas-item">P1</div>
                </div>
                <div id="pemasaranScheduleContainer">
                    <!-- Tabel akan di-generate berdasarkan mata kuliah -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk ringkasan -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSummary()">&times;</span>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìä Ringkasan Jadwal Dosen dengan SKS</h2>
                <button class="btn btn-success" onclick="printSummaryPDF()" style="background: #16a085; margin-left: 15px;">üñ®Ô∏è Cetak PDF</button>
            </div>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        // Data dosen lengkap (50 dosen)
        const dosenList = [
            "Prof. Dr. H. Abd. Rahman Kadir, SE., M.Si., CIPM",
            "Prof. Dr. Mursalim Nohong, SE., M.Si., CRA., CRP., CWM",
            "Prof. Dr. Abdul Razak Munir, SE., M.Si., M.Mktg., C.MP., CMA",
            "Prof. Dr. Cepi Pahlevi, SE., M.Si",
            "Prof. Dr. H. Abd. Rakhman Laba, SE., MBA",
            "Prof. Dr. H. Djabir Hamzah, MA",
            "Prof. Dr. H. Jusni, SE., M.Si",
            "Prof. Dr. H. Muh. Asdar, SE., M.Si",
            "Prof. Dr. H. Muh. Yunus Amar, SE., MT",
            "Prof. Dr. H. Muhammad Ali, SE., MS",
            "Prof. Dr. H. Syamsu Alam, SE., M.Si., CIPM",
            "Prof. Dr. Haris Maupa, SE., M.Si",
            "Prof. Dr. Hj. Indrianty Sudirman, SE., M.Si",
            "Prof. Dr. Hj. Mahlia Muis. SE., M.Si",
            "Prof. Dr. Hj. Nuraeni Kadir, SE., M.SI",
            "Prof. Dr. Hj. Nurdjanah Hamid, SE., M.Agr",
            "Prof. Dr. Hj. Siti Haerani, SE., M.Si",
            "Prof. Dr. Idayanti Nursyamsi, SE., M.Si",
            "Prof. Dr. Maat Pono, SE., M.Si",
            "Prof. Dr. Muh. Idrus Taba, SE., M.Si",
            "Prof. Dr. Musran Munizu, SE., M.Si., M.A.P",
            "Prof. Dr. Nurdin Brasit, SE., M.Si",
            "Prof. Dr. Otto R. Payangan, SE., M.Si",
            "Prof. Dr. Ria Mardiana Y, SE., M.Si",
            "Prof. Dr. Sumardi, SE., M.Si",
            "Prof. Dra. Hj. Dian A.S Parawansa, M.Si., Ph.D",
            "Dra. Hj. Andi Reni, Ph.D., CSEM., CWM",
            "Abdullah Sanusi, SE., MBA., Ph.D",
            "Andi Aswan, SE., MBA., M.Phil., DBA",
            "Dr. Sabbar Dahham Sabbar, Dip., Sc.Pub.Adm., M.BA",
            "Dr. Andi Nur Baumassepe, SE., MM",
            "Dr. Andi Tenri Harahap, BA(Hons)., MM., CWM",
            "Dr. Asty Almaida, SE., M.Si",
            "Dr. Eka Sastra, SE., ME",
            "Dr. Fahrina Mustafa, SE., M.Si",
            "Dr. Fauzi R. Rahim, SE., M.Si., CFP., AEPP",
            "Dr. Fauziah Umar, SE., M.Si",
            "Dr. H. Muhammad Toaha, SE., MBA",
            "Dr. Hendragunawan, S.Thayf, SE., M.Si",
            "Dr. Hj. Andi Ratna Sari Dewi, SE., M.Si",
            "Dr. Hj. Haeriah Hakim, SE., M.Mktg",
            "Dr. Hj. Wardhani Hakim, SE., M.Si",
            "Dr. Indraswati T.R., SE., MA",
            "Dr. Julius Jilbert, SE., MIT",
            "Dr. Muhammad Ismail, SE., M.Si., CMA",
            "Dr. Nur Alamzah, SE., M.Si",
            "Dr. Romi Setiawan, MM",
            "Dr. Sabir, SE., M.Si",
            "Dr. Shinta Dewi Sugiharti Tikson, M.Mktg",
            "Dr. Wahda, SE., M.Pd., M.Si"
        ];

        // Data kelas per kategori
        const kelasData = {
            umum: ['B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8'],
            strategik: ['S1', 'S2'],
            keuangan: ['K1', 'K2'],
            sdm: ['H1', 'H2'],
            pemasaran: ['P1']
        };

        // Storage untuk mata kuliah dan jadwal
        let mataKuliah = {
            umum: [],
            strategik: [],
            keuangan: [],
            sdm: [],
            pemasaran: []
        };

        let scheduleData = {};
        let conflicts = [];
        let currentTab = 'matkul';
        let editingMatkulId = null;

        // Initialize default mata kuliah
        function initializeDefaultMataKuliah() {
            const defaultMK = {
                umum: [
                    {id: 'umum1', nama: 'Strategic Business and Policy', sks: 3, waktu: '07.30 - 10.00'},
                    {id: 'umum2', nama: 'Business Research', sks: 3, waktu: '10.05 - 12.35'},
                    {id: 'umum3', nama: 'Risk and Wealth Management', sks: 3, waktu: '13.00 - 15.10'},
                    {id: 'umum4', nama: 'Digital Business Transformation', sks: 3, waktu: '16.00 - 18.10'}
                ],
                strategik: [
                    {id: 'strategik1', nama: 'Industry and Competitive Analysis', sks: 3, waktu: '07.30 - 10.00'},
                    {id: 'strategik2', nama: 'Leadership Strategic', sks: 3, waktu: '10.05 - 12.00'},
                    {id: 'strategik3', nama: 'Corporate Strategic', sks: 3, waktu: '13.00 - 15.30'}
                ],
                keuangan: [
                    {id: 'keuangan1', nama: 'Corporate Financial', sks: 3, waktu: '07.30 - 10.00'},
                    {id: 'keuangan2', nama: 'Financial Strategy Analysis', sks: 3, waktu: '10.05 - 12.00'},
                    {id: 'keuangan3', nama: 'The Financial Service Ecosystem', sks: 3, waktu: '13.00 - 15.30'}
                ],
                sdm: [
                    {id: 'sdm1', nama: 'Structure and Organizational Behavior', sks: 3, waktu: '07.30 - 10.00'},
                    {id: 'sdm2', nama: 'Strategic Human Resources', sks: 3, waktu: '10.05 - 12.00'},
                    {id: 'sdm3', nama: 'Organizational Change and Development', sks: 3, waktu: '13.00 - 15.30'}
                ],
                pemasaran: [
                    {id: 'pemasaran1', nama: 'Marketing Strategic', sks: 3, waktu: '07.30 - 10.00'},
                    {id: 'pemasaran2', nama: 'Brand Ecosystem', sks: 3, waktu: '10.05 - 12.00'},
                    {id: 'pemasaran3', nama: 'Matrix Marketing', sks: 3, waktu: '13.00 - 15.30'}
                ]
            };

            // Load from localStorage or use default
            const saved = localStorage.getItem('mataKuliahData');
            mataKuliah = saved ? JSON.parse(saved) : defaultMK;
        }

        // Tambah mata kuliah
        function addMataKuliah() {
            const nama = document.getElementById('matkulName').value.trim();
            const sks = parseInt(document.getElementById('matkulSKS').value);
            const waktu = document.getElementById('matkulWaktu').value;
            const kategori = document.getElementById('matkulKategori').value;

            if (!nama) {
                alert('Nama mata kuliah tidak boleh kosong!');
                return;
            }

            if (editingMatkulId) {
                // Edit mode
                const mk = findMatkulById(editingMatkulId);
                if (mk) {
                    mk.nama = nama;
                    mk.sks = sks;
                    mk.waktu = waktu;
                    
                    // Jika kategori berubah, pindahkan mata kuliah
                    if (mk.kategori !== kategori) {
                        // Hapus dari kategori lama
                        const oldKategori = mk.kategori;
                        mataKuliah[oldKategori] = mataKuliah[oldKategori].filter(m => m.id !== editingMatkulId);
                        
                        // Tambahkan ke kategori baru
                        mk.kategori = kategori;
                        mataKuliah[kategori].push(mk);
                    }
                }
                editingMatkulId = null;
                document.querySelector('.form-row button').textContent = 'Tambah MK';
            } else {
                // Add mode
                const newMK = {
                    id: 'mk_' + Date.now(),
                    nama: nama,
                    sks: sks,
                    waktu: waktu,
                    kategori: kategori
                };
                
                mataKuliah[kategori].push(newMK);
            }

            // Clear form
            document.getElementById('matkulName').value = '';
            document.getElementById('matkulSKS').value = 3;
            document.getElementById('matkulWaktu').selectedIndex = 0;
            document.getElementById('matkulKategori').selectedIndex = 0;

            saveMataKuliah();
            renderMataKuliahList();
            generateAllScheduleTables();
            updateAllStats();
        }

        // Find mata kuliah by ID
        function findMatkulById(id) {
            for (const kategori in mataKuliah) {
                const mk = mataKuliah[kategori].find(m => m.id === id);
                if (mk) {
                    mk.kategori = kategori;
                    return mk;
                }
            }
            return null;
        }

        // Edit mata kuliah
        function editMataKuliah(id) {
            const mk = findMatkulById(id);
            if (!mk) return;

            document.getElementById('matkulName').value = mk.nama;
            document.getElementById('matkulSKS').value = mk.sks;
            document.getElementById('matkulWaktu').value = mk.waktu;
            document.getElementById('matkulKategori').value = mk.kategori;

            editingMatkulId = id;
            document.querySelector('.form-row button').textContent = 'Update MK';
            
            // Switch to mata kuliah tab
            showTab('matkul');
        }

        // Hapus mata kuliah
        function deleteMataKuliah(id) {
            const mk = findMatkulById(id);
            if (!mk) return;

            if (confirm(`Hapus mata kuliah "${mk.nama}"?\n\nPeringatan: Semua jadwal yang terkait akan ikut terhapus!`)) {
                // Hapus dari array mata kuliah
                mataKuliah[mk.kategori] = mataKuliah[mk.kategori].filter(m => m.id !== id);
                
                // Hapus dari jadwal
                if (scheduleData[mk.kategori]) {
                    Object.keys(scheduleData[mk.kategori]).forEach(kelas => {
                        if (scheduleData[mk.kategori][kelas][mk.nama]) {
                            delete scheduleData[mk.kategori][kelas][mk.nama];
                        }
                    });
                }

                saveMataKuliah();
                saveScheduleData();
                renderMataKuliahList();
                generateAllScheduleTables();
                updateAllStats();
                checkConflicts();
            }
        }

        // Render daftar mata kuliah
        function renderMataKuliahList() {
            const container = document.getElementById('matkulList');
            container.innerHTML = '';

            Object.keys(mataKuliah).forEach(kategori => {
                if (mataKuliah[kategori].length === 0) return;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'matkul-category';

                const header = document.createElement('div');
                header.className = 'category-header';
                header.textContent = kategori.charAt(0).toUpperCase() + kategori.slice(1);
                categoryDiv.appendChild(header);

                mataKuliah[kategori].forEach(mk => {
                    const item = document.createElement('div');
                    item.className = 'matkul-item';
                    
                    item.innerHTML = `
                        <div class="matkul-info">
                            <div class="matkul-name">${mk.nama}</div>
                            <div class="matkul-details">${mk.sks} SKS ‚Ä¢ ${mk.waktu}</div>
                        </div>
                        <div class="matkul-actions">
                            <button class="btn btn-primary btn-small" onclick="editMataKuliah('${mk.id}')">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteMataKuliah('${mk.id}')">Hapus</button>
                        </div>
                    `;
                    
                    categoryDiv.appendChild(item);
                });

                container.appendChild(categoryDiv);
            });

            updateMatkulStats();
        }

        // Update statistik mata kuliah
        function updateMatkulStats() {
            Object.keys(mataKuliah).forEach(kategori => {
                const element = document.getElementById(`matkul${kategori.charAt(0).toUpperCase() + kategori.slice(1)}`);
                if (element) {
                    element.textContent = mataKuliah[kategori].length;
                }
            });
        }

        // Generate schedule table untuk kategori tertentu
        function generateScheduleTable(kategori) {
            const container = document.getElementById(kategori + 'ScheduleContainer');
            if (!container) return;

            const mkList = mataKuliah[kategori] || [];
            if (mkList.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">Belum ada mata kuliah untuk kategori ini. Tambahkan mata kuliah di tab "MATA KULIAH".</p>';
                return;
            }

            // Sort mata kuliah berdasarkan waktu
            mkList.sort((a, b) => a.waktu.localeCompare(b.waktu));

            let tableHTML = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th class="kelas-header">Kelas</th>
            `;

            mkList.forEach(mk => {
                tableHTML += `
                    <th class="mata-kuliah-header">
                        ${mk.nama}
                        <span class="waktu-header">${mk.waktu}</span>
                        <span class="sks-header">${mk.sks} SKS</span>
                    </th>
                `;
            });

            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            kelasData[kategori].forEach(kelas => {
                tableHTML += `<tr><td class="kelas-header"><strong>${kelas}</strong></td>`;
                
                mkList.forEach(mk => {
                    const sksPerDosen = mk.sks / 2;
                    tableHTML += `
                        <td>
                            <div class="dosen-input-container">
                                <div class="dosen-label">Dosen 1:</div>
                                <select class="dosen-select" id="dosen_${kategori}_${kelas}_${mk.id}_1" onchange="onDosenChange()">
                                    <option value="">-- Pilih Dosen --</option>
                                    ${dosenList.map(dosen => `<option value="${dosen}">${dosen}</option>`).join('')}
                                </select>
                                <div class="sks-info">üë§ ${mk.sks} SKS | üë• ${sksPerDosen} SKS</div>
                                
                                <div class="dosen-label">Dosen 2:</div>
                                <select class="dosen-select" id="dosen_${kategori}_${kelas}_${mk.id}_2" onchange="onDosenChange()">
                                    <option value="">-- Pilih Dosen --</option>
                                    ${dosenList.map(dosen => `<option value="${dosen}">${dosen}</option>`).join('')}
                                </select>
                            </div>
                        </td>
                    `;
                });
                
                tableHTML += '</tr>';
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Generate semua tabel jadwal
        function generateAllScheduleTables() {
            Object.keys(kelasData).forEach(kategori => {
                generateScheduleTable(kategori);
            });
            loadScheduleData();
        }

        // Event handler untuk perubahan dosen
        function onDosenChange() {
            updateScheduleData();
            checkConflicts();
            updateAllStats();
        }

        // Update data jadwal
        function updateScheduleData() {
            scheduleData = {};
            
            Object.keys(kelasData).forEach(kategori => {
                scheduleData[kategori] = {};
                
                kelasData[kategori].forEach(kelas => {
                    scheduleData[kategori][kelas] = {};
                    
                    mataKuliah[kategori].forEach(mk => {
                        const dosen1Element = document.getElementById(`dosen_${kategori}_${kelas}_${mk.id}_1`);
                        const dosen2Element = document.getElementById(`dosen_${kategori}_${kelas}_${mk.id}_2`);
                        
                        if (dosen1Element && dosen2Element) {
                            scheduleData[kategori][kelas][mk.nama] = {
                                matkulId: mk.id,
                                waktu: mk.waktu,
                                sks: mk.sks,
                                dosen1: dosen1Element.value || '',
                                dosen2: dosen2Element.value || ''
                            };
                        }
                    });
                });
            });
        }

        // Check conflicts global
        function checkConflicts() {
            conflicts = [];
            
            // Reset semua conflict highlights
            document.querySelectorAll('.conflict').forEach(cell => {
                cell.classList.remove('conflict');
            });

            // Kumpulkan semua penugasan per waktu
            const penugasanPerWaktu = {};
            
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        const waktu = data.waktu;
                        
                        if (!penugasanPerWaktu[waktu]) {
                            penugasanPerWaktu[waktu] = {};
                        }
                        
                        // Cek dosen 1
                        if (data.dosen1 && data.dosen1 !== '') {
                            if (!penugasanPerWaktu[waktu][data.dosen1]) {
                                penugasanPerWaktu[waktu][data.dosen1] = [];
                            }
                            penugasanPerWaktu[waktu][data.dosen1].push({
                                kategori, kelas, mkNama, posisi: 'dosen1',
                                element: document.getElementById(`dosen_${kategori}_${kelas}_${data.matkulId}_1`)?.parentElement?.parentElement,
                                sks: data.sks
                            });
                        }
                        
                        // Cek dosen 2
                        if (data.dosen2 && data.dosen2 !== '') {
                            if (!penugasanPerWaktu[waktu][data.dosen2]) {
                                penugasanPerWaktu[waktu][data.dosen2] = [];
                            }
                            penugasanPerWaktu[waktu][data.dosen2].push({
                                kategori, kelas, mkNama, posisi: 'dosen2',
                                element: document.getElementById(`dosen_${kategori}_${kelas}_${data.matkulId}_2`)?.parentElement?.parentElement,
                                sks: data.sks
                            });
                        }
                    });
                });
            });

            // Deteksi konflik (overlap waktu dan waktu sama)
            Object.keys(penugasanPerWaktu).forEach(waktu1 => {
                Object.keys(penugasanPerWaktu).forEach(waktu2 => {
                    if (waktu1 !== waktu2 && isTimeOverlap(waktu1, waktu2)) {
                        // Ada overlap waktu
                        Object.keys(penugasanPerWaktu[waktu1]).forEach(dosen => {
                            if (penugasanPerWaktu[waktu2] && penugasanPerWaktu[waktu2][dosen]) {
                                const penugasan1 = penugasanPerWaktu[waktu1][dosen];
                                const penugasan2 = penugasanPerWaktu[waktu2][dosen];
                                
                                [...penugasan1, ...penugasan2].forEach(p => {
                                    if (p.element) p.element.classList.add('conflict');
                                });
                                
                                conflicts.push({
                                    dosen: dosen,
                                    waktu1: waktu1,
                                    waktu2: waktu2,
                                    penugasan1: penugasan1,
                                    penugasan2: penugasan2
                                });
                            }
                        });
                    }
                });
            });

            // Konflik pada waktu yang sama
            Object.keys(penugasanPerWaktu).forEach(waktu => {
                Object.keys(penugasanPerWaktu[waktu]).forEach(dosen => {
                    const penugasan = penugasanPerWaktu[waktu][dosen];
                    if (penugasan.length > 1) {
                        penugasan.forEach(p => {
                            if (p.element) p.element.classList.add('conflict');
                        });
                        
                        const existingConflict = conflicts.find(c => 
                            c.dosen === dosen && (c.waktu1 === waktu || c.waktu2 === waktu)
                        );
                        
                        if (!existingConflict) {
                            conflicts.push({
                                dosen: dosen,
                                waktu1: waktu,
                                waktu2: waktu,
                                penugasan1: penugasan,
                                penugasan2: []
                            });
                        }
                    }
                });
            });

            displayConflicts();
        }

        // Check if two time slots overlap
        function isTimeOverlap(waktu1, waktu2) {
            const parseTime = (timeStr) => {
                const [start, end] = timeStr.split(' - ');
                const parseHour = (time) => {
                    const [hour, minute] = time.split('.');
                    return parseInt(hour) * 60 + parseInt(minute);
                };
                return {
                    start: parseHour(start),
                    end: parseHour(end)
                };
            };

            const time1 = parseTime(waktu1);
            const time2 = parseTime(waktu2);

            return !(time1.end <= time2.start || time2.end <= time1.start);
        }

        // Display conflicts
        function displayConflicts() {
            const conflictList = document.getElementById('conflictList');
            const conflictItems = document.getElementById('conflictItems');
            
            if (conflicts.length > 0) {
                conflictItems.innerHTML = '';
                
                const conflictsByDosen = {};
                conflicts.forEach(conflict => {
                    if (!conflictsByDosen[conflict.dosen]) {
                        conflictsByDosen[conflict.dosen] = [];
                    }
                    conflictsByDosen[conflict.dosen].push(conflict);
                });

                Object.keys(conflictsByDosen).forEach(dosen => {
                    const dosenConflicts = conflictsByDosen[dosen];
                    const item = document.createElement('div');
                    item.className = 'conflict-item';
                    
                    let detailHTML = `<strong>${dosen}</strong><br>`;
                    
                    dosenConflicts.forEach(conflict => {
                        if (conflict.waktu1 === conflict.waktu2) {
                            detailHTML += `Bentrok pada waktu <strong>${conflict.waktu1}</strong><br>`;
                            conflict.penugasan1.forEach(p => {
                                detailHTML += `‚Ä¢ ${p.kategori.toUpperCase()} ${p.kelas} - ${p.mkNama} (${p.posisi}) - ${p.sks} SKS<br>`;
                            });
                        } else {
                            detailHTML += `Bentrok antara waktu <strong>${conflict.waktu1}</strong> dan <strong>${conflict.waktu2}</strong><br>`;
                            conflict.penugasan1.forEach(p => {
                                detailHTML += `‚Ä¢ ${p.kategori.toUpperCase()} ${p.kelas} - ${p.mkNama} (${p.posisi}) pada ${conflict.waktu1}<br>`;
                            });
                            conflict.penugasan2.forEach(p => {
                                detailHTML += `‚Ä¢ ${p.kategori.toUpperCase()} ${p.kelas} - ${p.mkNama} (${p.posisi}) pada ${conflict.waktu2}<br>`;
                            });
                        }
                    });
                    
                    item.innerHTML = detailHTML;
                    conflictItems.appendChild(item);
                });
                
                conflictList.classList.add('show');
            } else {
                conflictList.classList.remove('show');
            }
        }

        // Update all statistics
        function updateAllStats() {
            updateScheduleData();
            
            // Hitung total mata kuliah dan SKS
            let totalMK = 0;
            let totalSKSSistem = 0;
            
            Object.keys(mataKuliah).forEach(kategori => {
                totalMK += mataKuliah[kategori].length;
                mataKuliah[kategori].forEach(mk => {
                    // Hitung berapa kelas yang menggunakan MK ini
                    const jumlahKelas = kelasData[kategori].length;
                    totalSKSSistem += mk.sks * jumlahKelas;
                });
            });

            // Hitung total assignments dan unique dosen
            let totalAssignments = 0;
            let uniqueDosen = new Set();
            let totalSKSAssigned = 0;
            
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        
                        if (data.dosen1 && data.dosen1 !== '') {
                            totalAssignments++;
                            uniqueDosen.add(data.dosen1);
                            // Jika hanya dosen1 yang mengajar
                            if (!data.dosen2 || data.dosen2 === '') {
                                totalSKSAssigned += data.sks; // Full SKS
                            } else {
                                totalSKSAssigned += data.sks / 2; // Half SKS
                            }
                        }
                        if (data.dosen2 && data.dosen2 !== '') {
                            totalAssignments++;
                            uniqueDosen.add(data.dosen2);
                            totalSKSAssigned += data.sks / 2; // Half SKS
                        }
                    });
                });
            });

            // Hitung unique conflict dosen
            const uniqueConflictDosen = new Set();
            conflicts.forEach(conflict => {
                uniqueConflictDosen.add(conflict.dosen);
            });

            const avgSKS = uniqueDosen.size > 0 ? (totalSKSAssigned / uniqueDosen.size).toFixed(1) : 0;

            // Update UI
            document.getElementById('totalMatkul').textContent = totalMK;
            document.getElementById('totalSKS').textContent = totalSKSSistem;
            document.getElementById('conflictCount').textContent = uniqueConflictDosen.size;
            document.getElementById('uniqueDosenCount').textContent = uniqueDosen.size;
            document.getElementById('avgSKS').textContent = avgSKS;
        }

        // Show summary
        function showSummary() {
            updateScheduleData();
            
            const dosenSummary = {};
            
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        
                        ['dosen1', 'dosen2'].forEach((dosenKey, index) => {
                            const dosen = data[dosenKey];
                            if (dosen && dosen !== '') {
                                if (!dosenSummary[dosen]) {
                                    dosenSummary[dosen] = [];
                                }
                                
                                const otherDosen = index === 0 ? data.dosen2 : data.dosen1;
                                const isTeamTeaching = otherDosen && otherDosen !== '';
                                const sksAssigned = isTeamTeaching ? data.sks / 2 : data.sks;
                                
                                dosenSummary[dosen].push({
                                    kategori: kategori.toUpperCase(),
                                    kelas: kelas,
                                    mataKuliah: mkNama,
                                    waktu: data.waktu,
                                    posisi: `Dosen ${index + 1}`,
                                    sks: sksAssigned,
                                    teamTeaching: isTeamTeaching
                                });
                            }
                        });
                    });
                });
            });

            let summaryHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <h4>üí° Sistem Perhitungan SKS</h4>
                    <p><strong>üë§ Solo Teaching:</strong> Dosen mendapat SKS penuh mata kuliah</p>
                    <p><strong>üë• Team Teaching:</strong> SKS mata kuliah dibagi 2 untuk setiap dosen</p>
                    <p><strong>üìä Rata-rata:</strong> ${Object.keys(dosenSummary).length > 0 ? (Object.values(dosenSummary).reduce((sum, jadwal) => sum + jadwal.reduce((s, j) => s + j.sks, 0), 0) / Object.keys(dosenSummary).length).toFixed(1) : 0} SKS per dosen</p>
                </div>
                
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Nama Dosen</th>
                            <th>Total SKS</th>
                            <th>Detail Jadwal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(dosenSummary).sort().forEach(dosen => {
                const jadwal = dosenSummary[dosen];
                const totalSKS = jadwal.reduce((sum, j) => sum + j.sks, 0);
                let detailHTML = '';
                
                // Group by kategori
                const byKategori = {};
                jadwal.forEach(item => {
                    if (!byKategori[item.kategori]) {
                        byKategori[item.kategori] = [];
                    }
                    byKategori[item.kategori].push(item);
                });
                
                Object.keys(byKategori).forEach(kategori => {
                    const kategorSKS = byKategori[kategori].reduce((sum, j) => sum + j.sks, 0);
                    detailHTML += `<div style="margin: 5px 0; padding: 8px; background: #e8f5e8; border-radius: 4px; font-weight: 600;">${kategori} (${kategorSKS} SKS)</div>`;
                    byKategori[kategori].forEach(item => {
                        const icon = item.teamTeaching ? 'üë•' : 'üë§';
                        detailHTML += `
                            <div style="margin: 2px 0 2px 15px; padding: 3px; background: #f8f9fa; border-radius: 3px; font-size: 12px;">
                                <strong>${item.kelas}</strong> - ${item.mataKuliah} 
                                <span style="color: #666;">(${item.waktu}) - ${item.posisi}</span>
                                <span style="color: #e67e22; font-weight: 600;">${icon} ${item.sks} SKS</span>
                            </div>
                        `;
                    });
                });

                summaryHTML += `
                    <tr>
                        <td style="font-weight: 600;">${dosen}</td>
                        <td style="text-align: center; font-weight: bold; color: #27ae60; font-size: 16px;">${totalSKS} SKS</td>
                        <td>${detailHTML}</td>
                    </tr>
                `;
            });

            summaryHTML += '</tbody></table>';

            // Tambahkan analisis beban kerja
            const totalDosen = Object.keys(dosenSummary).length;
            const totalSKSAssigned = Object.values(dosenSummary).reduce((sum, jadwal) => sum + jadwal.reduce((s, j) => s + j.sks, 0), 0);
            const avgSKSPerDosen = totalDosen > 0 ? (totalSKSAssigned / totalDosen).toFixed(1) : 0;

            summaryHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <h4>üìà Analisis Beban Kerja Global</h4>
                    <p><strong>Total Kelas:</strong> 15 kelas (8 umum + 7 konsentrasi)</p>
                    <p><strong>Total Dosen Aktif:</strong> ${totalDosen}</p>
                    <p><strong>Total SKS Terassign:</strong> ${totalSKSAssigned} SKS</p>
                    <p><strong>Rata-rata SKS per Dosen:</strong> ${avgSKSPerDosen} SKS</p>
                    <p><strong>50 Dosen Tersedia:</strong> Database lengkap siap digunakan</p>
                </div>
            `;

            document.getElementById('summaryContent').innerHTML = summaryHTML;
            document.getElementById('summaryModal').style.display = 'block';
        }

        // Print summary to PDF
        function printSummaryPDF() {
            updateScheduleData();
            
            const dosenSummary = {};
            
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        
                        ['dosen1', 'dosen2'].forEach((dosenKey, index) => {
                            const dosen = data[dosenKey];
                            if (dosen && dosen !== '') {
                                if (!dosenSummary[dosen]) {
                                    dosenSummary[dosen] = [];
                                }
                                
                                const otherDosen = index === 0 ? data.dosen2 : data.dosen1;
                                const isTeamTeaching = otherDosen && otherDosen !== '';
                                const sksAssigned = isTeamTeaching ? data.sks / 2 : data.sks;
                                
                                dosenSummary[dosen].push({
                                    kategori: kategori.toUpperCase(),
                                    kelas: kelas,
                                    mataKuliah: mkNama,
                                    waktu: data.waktu,
                                    posisi: `Dosen ${index + 1}`,
                                    sks: sksAssigned,
                                    teamTeaching: isTeamTeaching
                                });
                            }
                        });
                    });
                });
            });

            // Create printable HTML
            const currentDate = new Date().toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const totalDosen = Object.keys(dosenSummary).length;
            const totalSKSAssigned = Object.values(dosenSummary).reduce((sum, jadwal) => sum + jadwal.reduce((s, j) => s + j.sks, 0), 0);
            const avgSKSPerDosen = totalDosen > 0 ? (totalSKSAssigned / totalDosen).toFixed(1) : 0;

            let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Ringkasan Jadwal Dosen - ${currentDate}</title>
                    <style>
                        @media print {
                            @page { margin: 1.5cm; size: A4; }
                            body { font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.3; }
                        }
                        body { font-family: 'Times New Roman', serif; margin: 0; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                        .header h1 { margin: 0; font-size: 18pt; font-weight: bold; }
                        .header h2 { margin: 5px 0; font-size: 14pt; color: #666; }
                        .header p { margin: 5px 0; font-size: 10pt; color: #888; }
                        .summary-info { background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
                        .summary-info h3 { margin: 0 0 10px 0; color: #333; }
                        .summary-info p { margin: 3px 0; font-size: 10pt; }
                        .dosen-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        .dosen-table th { background: #2c3e50; color: white; padding: 8px; text-align: left; font-size: 10pt; }
                        .dosen-table td { padding: 6px 8px; border-bottom: 1px solid #ddd; font-size: 9pt; vertical-align: top; }
                        .dosen-name { font-weight: bold; color: #2c3e50; }
                        .total-sks { text-align: center; font-weight: bold; color: #27ae60; font-size: 11pt; }
                        .detail-item { margin: 2px 0; padding: 3px 6px; background: #f8f9fa; border-radius: 3px; font-size: 8pt; }
                        .kategori-header { background: #e8f5e8; font-weight: bold; margin: 3px 0 1px 0; padding: 2px 6px; border-radius: 3px; }
                        .sks-info { color: #e67e22; font-weight: bold; }
                        .team-icon { color: #3498db; }
                        .solo-icon { color: #e74c3c; }
                        .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 8pt; color: #666; }
                        .page-break { page-break-before: always; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä RINGKASAN JADWAL MENGAJAR DOSEN</h1>
                        <h2>Sistem Jadwal Terintegrasi</h2>
                        <p>Dicetak pada: ${currentDate}</p>
                    </div>
                    
                    <div class="summary-info">
                        <h3>üí° Informasi Sistem Perhitungan SKS</h3>
                        <p><strong>üë§ Solo Teaching:</strong> Dosen mendapat SKS penuh mata kuliah</p>
                        <p><strong>üë• Team Teaching:</strong> SKS mata kuliah dibagi 2 untuk setiap dosen</p>
                        <p><strong>üìä Total Dosen Aktif:</strong> ${totalDosen} dosen</p>
                        <p><strong>üìà Total SKS Terassign:</strong> ${totalSKSAssigned} SKS</p>
                        <p><strong>üìä Rata-rata SKS per Dosen:</strong> ${avgSKSPerDosen} SKS</p>
                        <p><strong>üèõÔ∏è Total Kelas:</strong> 15 kelas (8 umum + 7 konsentrasi)</p>
                    </div>
                    
                    <table class="dosen-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Nama Dosen</th>
                                <th style="width: 10%;">Total SKS</th>
                                <th style="width: 55%;">Detail Jadwal Mengajar</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let dosenCount = 0;
            Object.keys(dosenSummary).sort().forEach(dosen => {
                dosenCount++;
                const jadwal = dosenSummary[dosen];
                const totalSKS = jadwal.reduce((sum, j) => sum + j.sks, 0);
                
                // Group by kategori
                const byKategori = {};
                jadwal.forEach(item => {
                    if (!byKategori[item.kategori]) {
                        byKategori[item.kategori] = [];
                    }
                    byKategori[item.kategori].push(item);
                });
                
                let detailHTML = '';
                Object.keys(byKategori).forEach(kategori => {
                    const kategorSKS = byKategori[kategori].reduce((sum, j) => sum + j.sks, 0);
                    detailHTML += `<div class="kategori-header">${kategori} (${kategorSKS} SKS)</div>`;
                    byKategori[kategori].forEach(item => {
                        const icon = item.teamTeaching ? '<span class="team-icon">üë•</span>' : '<span class="solo-icon">üë§</span>';
                        detailHTML += `
                            <div class="detail-item">
                                <strong>${item.kelas}</strong> - ${item.mataKuliah}<br>
                                <small>${item.waktu} - ${item.posisi} ${icon} <span class="sks-info">${item.sks} SKS</span></small>
                            </div>
                        `;
                    });
                });

                const pageBreak = dosenCount % 15 === 0 && dosenCount < Object.keys(dosenSummary).length ? ' page-break' : '';
                
                printHTML += `
                    <tr class="${pageBreak}">
                        <td class="dosen-name">${dosen}</td>
                        <td class="total-sks">${totalSKS}</td>
                        <td>${detailHTML}</td>
                    </tr>
                `;
            });

            printHTML += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Sistem Jadwal Mengajar Dosen Terintegrasi</p>
                        <p>Dicetak pada ${currentDate} | Total: ${totalDosen} dosen aktif</p>
                    </div>
                </body>
                </html>
            `;

            // Open in new window and print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        // Close summary modal
        function closeSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        // Export to Excel dengan format Excel sesungguhnya
        function exportExcel() {
            updateScheduleData();
            
            // Import SheetJS library dynamically
            if (typeof XLSX === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = () => generateExcelFile();
                document.head.appendChild(script);
            } else {
                generateExcelFile();
            }
        }
        
        function generateExcelFile() {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Database Mata Kuliah
            const matkulData = [];
            matkulData.push(['Kategori', 'Nama Mata Kuliah', 'SKS', 'Waktu']);
            
            Object.keys(mataKuliah).forEach(kategori => {
                mataKuliah[kategori].forEach(mk => {
                    matkulData.push([
                        kategori.toUpperCase(),
                        mk.nama,
                        mk.sks,
                        mk.waktu
                    ]);
                });
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(matkulData);
            XLSX.utils.book_append_sheet(wb, ws1, "Database Mata Kuliah");
            
            // Sheet 2: Jadwal Per Kelas
            const jadwalKelasData = [];
            jadwalKelasData.push(['Jenis Kelas', 'Kode Kelas', 'Mata Kuliah', 'Waktu', 'SKS Total', 'Dosen 1', 'SKS Dosen 1', 'Dosen 2', 'SKS Dosen 2', 'Team Teaching']);
            
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        const teamTeaching = (data.dosen1 && data.dosen2) ? 'Ya' : 'Tidak';
                        const sksDosen1 = data.dosen1 ? (teamTeaching === 'Ya' ? data.sks / 2 : data.sks) : 0;
                        const sksDosen2 = data.dosen2 ? (teamTeaching === 'Ya' ? data.sks / 2 : 0) : 0;
                        
                        jadwalKelasData.push([
                            kategori.toUpperCase(),
                            kelas,
                            mkNama,
                            data.waktu,
                            data.sks,
                            data.dosen1 || '',
                            sksDosen1,
                            data.dosen2 || '',
                            sksDosen2,
                            teamTeaching
                        ]);
                    });
                });
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(jadwalKelasData);
            XLSX.utils.book_append_sheet(wb, ws2, "Jadwal Per Kelas");
            
            // Sheet 3: Jadwal Per Dosen
            const jadwalDosenData = [];
            jadwalDosenData.push(['Nama Dosen', 'Jenis Kelas', 'Kode Kelas', 'Mata Kuliah', 'Waktu', 'Posisi', 'SKS', 'Team Teaching']);
            
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        
                        if (data.dosen1) {
                            const teamTeaching = data.dosen2 ? 'Ya' : 'Tidak';
                            const sks = teamTeaching === 'Ya' ? data.sks / 2 : data.sks;
                            jadwalDosenData.push([
                                data.dosen1,
                                kategori.toUpperCase(),
                                kelas,
                                mkNama,
                                data.waktu,
                                'Dosen 1',
                                sks,
                                teamTeaching
                            ]);
                        }
                        
                        if (data.dosen2) {
                            const sks = data.sks / 2;
                            jadwalDosenData.push([
                                data.dosen2,
                                kategori.toUpperCase(),
                                kelas,
                                mkNama,
                                data.waktu,
                                'Dosen 2',
                                sks,
                                'Ya'
                            ]);
                        }
                    });
                });
            });
            
            const ws3 = XLSX.utils.aoa_to_sheet(jadwalDosenData);
            XLSX.utils.book_append_sheet(wb, ws3, "Jadwal Per Dosen");
            
            // Sheet 4: Matriks Waktu
            const matriksWaktuData = [];
            matriksWaktuData.push(['Waktu', 'Kategori Kelas', 'Kode Kelas', 'Mata Kuliah', 'SKS', 'Dosen 1', 'Dosen 2']);
            
            const waktuSet = new Set();
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        waktuSet.add(scheduleData[kategori][kelas][mkNama].waktu);
                    });
                });
            });
            
            Array.from(waktuSet).sort().forEach(waktu => {
                Object.keys(scheduleData).forEach(kategori => {
                    Object.keys(scheduleData[kategori]).forEach(kelas => {
                        Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                            const data = scheduleData[kategori][kelas][mkNama];
                            if (data.waktu === waktu) {
                                matriksWaktuData.push([
                                    waktu,
                                    kategori.toUpperCase(),
                                    kelas,
                                    mkNama,
                                    data.sks,
                                    data.dosen1 || '',
                                    data.dosen2 || ''
                                ]);
                            }
                        });
                    });
                });
            });
            
            const ws4 = XLSX.utils.aoa_to_sheet(matriksWaktuData);
            XLSX.utils.book_append_sheet(wb, ws4, "Matriks Waktu");
            
            // Sheet 5: Ringkasan Beban Kerja
            const dosenSummary = {};
            Object.keys(scheduleData).forEach(kategori => {
                Object.keys(scheduleData[kategori]).forEach(kelas => {
                    Object.keys(scheduleData[kategori][kelas]).forEach(mkNama => {
                        const data = scheduleData[kategori][kelas][mkNama];
                        
                        [data.dosen1, data.dosen2].forEach((dosen, index) => {
                            if (dosen && dosen !== '') {
                                if (!dosenSummary[dosen]) {
                                    dosenSummary[dosen] = {
                                        totalSKS: 0,
                                        totalKelas: 0,
                                        umum: 0,
                                        strategik: 0,
                                        keuangan: 0,
                                        sdm: 0,
                                        pemasaran: 0
                                    };
                                }
                                
                                const isTeamTeaching = data.dosen1 && data.dosen2;
                                const sks = isTeamTeaching ? data.sks / 2 : data.sks;
                                
                                dosenSummary[dosen].totalSKS += sks;
                                dosenSummary[dosen].totalKelas += 1;
                                dosenSummary[dosen][kategori] += sks;
                            }
                        });
                    });
                });
            });
            
            const ringkasanData = [];
            ringkasanData.push(['Nama Dosen', 'Total SKS', 'Total Kelas', 'UMUM', 'STRATEGIK', 'KEUANGAN', 'SDM', 'PEMASARAN']);
            
            Object.keys(dosenSummary).sort().forEach(dosen => {
                const summary = dosenSummary[dosen];
                ringkasanData.push([
                    dosen,
                    summary.totalSKS,
                    summary.totalKelas,
                    summary.umum,
                    summary.strategik,
                    summary.keuangan,
                    summary.sdm,
                    summary.pemasaran
                ]);
            });
            
            const ws5 = XLSX.utils.aoa_to_sheet(ringkasanData);
            XLSX.utils.book_append_sheet(wb, ws5, "Ringkasan Beban Kerja");
            
            // Sheet 6: Daftar Konflik
            const konflikData = [];
            konflikData.push(['Nama Dosen', 'Jenis Konflik', 'Waktu 1', 'Waktu 2', 'Detail Konflik']);
            
            conflicts.forEach(conflict => {
                const jenisKonflik = conflict.waktu1 === conflict.waktu2 ? 'Waktu Sama' : 'Overlap Waktu';
                let detailKonflik = '';
                
                conflict.penugasan1.forEach(p => {
                    detailKonflik += `${p.kategori.toUpperCase()} ${p.kelas} - ${p.mkNama} (${p.posisi}); `;
                });
                conflict.penugasan2.forEach(p => {
                    detailKonflik += `${p.kategori.toUpperCase()} ${p.kelas} - ${p.mkNama} (${p.posisi}); `;
                });
                
                konflikData.push([
                    conflict.dosen,
                    jenisKonflik,
                    conflict.waktu1,
                    conflict.waktu2,
                    detailKonflik
                ]);
            });
            
            const ws6 = XLSX.utils.aoa_to_sheet(konflikData);
            XLSX.utils.book_append_sheet(wb, ws6, "Daftar Konflik");
            
            // Sheet 7: Statistik Sistem
            const totalMK = Object.keys(mataKuliah).reduce((sum, kat) => sum + mataKuliah[kat].length, 0);
            const totalSKSSistem = Object.keys(mataKuliah).reduce((sum, kat) => {
                return sum + mataKuliah[kat].reduce((s, mk) => s + (mk.sks * kelasData[kat].length), 0);
            }, 0);
            const totalDosenAktif = Object.keys(dosenSummary).length;
            const totalKonflik = conflicts.length;
            const avgSKSPerDosen = totalDosenAktif > 0 ? (Object.values(dosenSummary).reduce((sum, s) => sum + s.totalSKS, 0) / totalDosenAktif).toFixed(1) : 0;
            
            const statistikData = [];
            statistikData.push(['Kategori', 'Nilai', 'Keterangan']);
            statistikData.push(['Total Mata Kuliah', totalMK, 'Semua kategori']);
            statistikData.push(['Total SKS Sistem', totalSKSSistem, 'Kapasitas maksimal']);
            statistikData.push(['Total Kelas', 15, '8 umum + 7 konsentrasi']);
            statistikData.push(['Dosen Tersedia', 50, 'Database lengkap']);
            statistikData.push(['Dosen Aktif', totalDosenAktif, 'Yang sudah ditugaskan']);
            statistikData.push(['Total Konflik', totalKonflik, 'Bentrok jadwal']);
            statistikData.push(['Rata-rata SKS per Dosen', avgSKSPerDosen, 'Beban mengajar']);
            statistikData.push(['Sistem Perhitungan', 'Solo: SKS penuh | Team: SKS/2', 'Otomatis']);
            
            const ws7 = XLSX.utils.aoa_to_sheet(statistikData);
            XLSX.utils.book_append_sheet(wb, ws7, "Statistik Sistem");
            
            // Download Excel file
            const filename = `Jadwal_Dosen_Terintegrasi_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            alert('üìä Excel berhasil diexport!\n\n‚úÖ File: ' + filename + '\nüìã 7 Sheet telah dihasilkan:\n1. Database Mata Kuliah\n2. Jadwal Per Kelas\n3. Jadwal Per Dosen\n4. Matriks Waktu\n5. Ringkasan Beban Kerja\n6. Daftar Konflik\n7. Statistik Sistem');
        }

        // Reset all data with enhanced double confirmation and proper cleanup
        function resetAll() {
            // First confirmation
            const firstConfirm = confirm('‚ö†Ô∏è PERINGATAN RESET SISTEM ‚ö†Ô∏è\n\nAnda akan menghapus SEMUA data:\n‚Ä¢ Mata kuliah custom\n‚Ä¢ Jadwal yang sudah diinput\n‚Ä¢ Kembali ke pengaturan default\n\nApakah Anda yakin ingin melanjutkan?');
            
            if (!firstConfirm) {
                return;
            }
            
            // Second confirmation with more serious warning
            const secondConfirm = confirm('üö® KONFIRMASI TERAKHIR üö®\n\nSemua data akan HILANG PERMANEN!\n\nTidak dapat dibatalkan setelah ini!\n\nKlik OK untuk MENGHAPUS SEMUA DATA\nKlik Cancel untuk MEMBATALKAN');
            
            if (!secondConfirm) {
                alert('‚úÖ Reset dibatalkan. Data Anda aman.');
                return;
            }
            
            try {
                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;text-align:center;';
                loadingMsg.innerHTML = '‚è≥ Mereset sistem...<br><small>Mohon tunggu...</small>';
                document.body.appendChild(loadingMsg);
                
                setTimeout(() => {
                    try {
                        // Clear all localStorage
                        localStorage.removeItem('mataKuliahData');
                        localStorage.removeItem('scheduleDataIntegrated');
                        localStorage.removeItem('hasVisitedCustom');
                        
                        // Reset global variables
                        mataKuliah = {};
                        scheduleData = {};
                        conflicts = [];
                        editingMatkulId = null;
                        
                        // Clear editing form
                        const matkulNameInput = document.getElementById('matkulName');
                        const matkulSKSInput = document.getElementById('matkulSKS');
                        const matkulWaktuSelect = document.getElementById('matkulWaktu');
                        const matkulKategoriSelect = document.getElementById('matkulKategori');
                        const formButton = document.querySelector('.form-row .btn');
                        
                        if (matkulNameInput) matkulNameInput.value = '';
                        if (matkulSKSInput) matkulSKSInput.value = 3;
                        if (matkulWaktuSelect) matkulWaktuSelect.selectedIndex = 0;
                        if (matkulKategoriSelect) matkulKategoriSelect.selectedIndex = 0;
                        if (formButton) formButton.textContent = 'Tambah MK';
                        
                        // Reset all dropdown selections in schedule tables
                        const allSelects = document.querySelectorAll('.dosen-select');
                        allSelects.forEach(select => {
                            if (select) select.selectedIndex = 0;
                        });
                        
                        // Remove all conflict highlights
                        const conflictElements = document.querySelectorAll('.conflict');
                        conflictElements.forEach(element => {
                            element.classList.remove('conflict');
                        });
                        
                        // Hide conflict list
                        const conflictList = document.getElementById('conflictList');
                        if (conflictList) {
                            conflictList.classList.remove('show');
                        }
                        
                        // Close any open modals
                        const summaryModal = document.getElementById('summaryModal');
                        if (summaryModal) {
                            summaryModal.style.display = 'none';
                        }
                        
                        // Reset to default mata kuliah
                        initializeDefaultMataKuliah();
                        
                        // Regenerate all components
                        renderMataKuliahList();
                        generateAllScheduleTables();
                        updateAllStats();
                        
                        // Remove loading message
                        document.body.removeChild(loadingMsg);
                        
                        // Show success message
                        alert('‚úÖ RESET BERHASIL!\n\nüéØ Sistem telah dikembalikan ke pengaturan default:\n‚Ä¢ Mata kuliah default telah dimuat\n‚Ä¢ Semua jadwal telah dibersihkan\n‚Ä¢ Data tersimpan otomatis\n\nüìö Silakan mulai input data dari tab "MATA KULIAH"');
                        
                        // Switch to mata kuliah tab
                        showTab('matkul');
                        
                        // Update current tab indicator
                        document.querySelectorAll('.tab').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelector('[onclick="showTab(\'matkul\')"]').classList.add('active');
                        
                    } catch (innerError) {
                        // Remove loading message if exists
                        if (document.body.contains(loadingMsg)) {
                            document.body.removeChild(loadingMsg);
                        }
                        
                        console.error('Inner reset error:', innerError);
                        alert('‚ùå Terjadi kesalahan saat reset!\n\nSilakan refresh halaman secara manual (F5 atau Ctrl+R) untuk reset lengkap.');
                    }
                }, 500);
                
            } catch (error) {
                console.error('Reset error:', error);
                alert('‚ùå Terjadi kesalahan saat reset!\n\nCoba langkah berikut:\n1. Refresh halaman (F5)\n2. Hapus cache browser\n3. Tutup dan buka kembali browser');
            }
        }

        // Show tab with proper state management
        function showTab(tabName) {
            try {
                // Hide all sections
                document.querySelectorAll('.schedule-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Deactivate all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected section
                const targetSection = document.getElementById(tabName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Activate selected tab
                const targetTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // Update current tab
                currentTab = tabName;
                
            } catch (error) {
                console.error('Tab switch error:', error);
            }
        }

        // Auto-save mata kuliah
        function saveMataKuliah() {
            try {
                localStorage.setItem('mataKuliahData', JSON.stringify(mataKuliah));
            } catch (error) {
                console.error('Error saving mata kuliah:', error);
            }
        }

        // Auto-save schedule data
        function saveScheduleData() {
            try {
                updateScheduleData();
                localStorage.setItem('scheduleDataIntegrated', JSON.stringify(scheduleData));
            } catch (error) {
                console.error('Error saving schedule data:', error);
            }
        }

        // Load schedule data with proper error handling
        function loadScheduleData() {
            try {
                const saved = localStorage.getItem('scheduleDataIntegrated');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Delay to ensure DOM elements are ready
                    setTimeout(() => {
                        Object.keys(data).forEach(kategori => {
                            if (data[kategori]) {
                                Object.keys(data[kategori]).forEach(kelas => {
                                    if (data[kategori][kelas]) {
                                        Object.keys(data[kategori][kelas]).forEach(mkNama => {
                                            const scheduleItem = data[kategori][kelas][mkNama];
                                            if (scheduleItem && scheduleItem.matkulId) {
                                                const matkulId = scheduleItem.matkulId;
                                                
                                                const dosen1Element = document.getElementById(`dosen_${kategori}_${kelas}_${matkulId}_1`);
                                                const dosen2Element = document.getElementById(`dosen_${kategori}_${kelas}_${matkulId}_2`);
                                                
                                                if (dosen1Element && scheduleItem.dosen1) {
                                                    dosen1Element.value = scheduleItem.dosen1;
                                                }
                                                if (dosen2Element && scheduleItem.dosen2) {
                                                    dosen2Element.value = scheduleItem.dosen2;
                                                }
                                            }
                                        });
                                    }
                                });
                            }
                        });
                        
                        updateScheduleData();
                        checkConflicts();
                        updateAllStats();
                    }, 500);
                }
            } catch (error) {
                console.error('Error loading schedule data:', error);
            }
        }

        // Auto-save on every change with debouncing
        let saveTimeout;
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('dosen-select')) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveScheduleData();
                }, 300);
            }
        });

        // Modal event listener
        window.onclick = function(event) {
            const modal = document.getElementById('summaryModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Initialize application with proper data persistence
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize mata kuliah first
                initializeDefaultMataKuliah();
                
                // Render mata kuliah list
                renderMataKuliahList();
                
                // Generate all schedule tables
                generateAllScheduleTables();
                
                // Update statistics
                updateAllStats();
                
                // Welcome message for new users
                setTimeout(() => {
                    if (!localStorage.getItem('hasVisitedCustom')) {
                        alert('üéâ Selamat Datang di Sistem Jadwal Terintegrasi!\n\n‚ú® Fitur Lengkap:\n‚Ä¢ üìö Manajemen mata kuliah kustomisasi\n‚Ä¢ ‚öñÔ∏è Perhitungan SKS fleksibel (1-6 SKS)\n‚Ä¢ üë• Team teaching dengan 2 dosen\n‚Ä¢ üîç Deteksi konflik global 15 kelas\n‚Ä¢ üìä Export Excel format XLSX\n‚Ä¢ üñ®Ô∏è Cetak PDF ringkasan dosen\n‚Ä¢ üíæ Auto-save data otomatis\n‚Ä¢ üîÑ Reset dengan konfirmasi ganda\n\nüí° Tips:\n1. Mulai dari tab "MATA KULIAH" untuk mengelola kurikulum\n2. Data akan tersimpan otomatis setiap perubahan\n3. Gunakan "Cek Konflik Global" untuk validasi jadwal\n\nüöÄ Selamat menggunakan sistem!');
                        localStorage.setItem('hasVisitedCustom', 'true');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('‚ö†Ô∏è Terjadi kesalahan saat memuat aplikasi.\nSilakan refresh halaman.');
            }
        });
    </script>
</body>
</html>